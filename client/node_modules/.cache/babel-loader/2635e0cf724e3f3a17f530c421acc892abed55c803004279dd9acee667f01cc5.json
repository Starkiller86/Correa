{"ast":null,"code":"// services/socket.js\nclass SocketService {\n  static getInstance() {\n    if (!SocketService.instance) {\n      SocketService.instance = new SocketService();\n    }\n    return SocketService.instance;\n  }\n  constructor() {\n    this.socket = null;\n    this.callbacks = {};\n    this.retryCount = 0;\n    const hostname = window.location.hostname;\n    this.wsUrl = `ws://${hostname}:8080`; // WebSocket dinámico\n    this.baseUrl = `http://${hostname}:3001`; // REST\n  }\n  connect() {\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) return;\n    this.socket = new WebSocket(this.wsUrl);\n    this.socket.onopen = () => {\n      this.retryCount = 0;\n    };\n    this.socket.onmessage = msg => {\n      try {\n        const data = JSON.parse(msg.data);\n        const type = data === null || data === void 0 ? void 0 : data.type;\n        if (type && this.callbacks[type]) {\n          this.callbacks[type](data);\n        }\n      } catch (e) {\n        console.error('❌ Error procesando mensaje WS:', e);\n      }\n    };\n    this.socket.onclose = () => this.scheduleReconnect();\n    this.socket.onerror = e => console.error('⚠️ WS error:', e);\n  }\n  scheduleReconnect() {\n    const delay = Math.min(1000 * 2 ** this.retryCount, 30000);\n    this.retryCount += 1;\n    setTimeout(() => this.connect(), delay);\n  }\n  on(type, cb) {\n    this.callbacks[type] = cb;\n  }\n  send(payload) {\n    var _this$socket;\n    if (((_this$socket = this.socket) === null || _this$socket === void 0 ? void 0 : _this$socket.readyState) === WebSocket.OPEN) {\n      this.socket.send(JSON.stringify(payload));\n    } else {\n      console.warn('WS no abierto, no se envió:', payload);\n    }\n  }\n  async waitForSocketReady(retries = 6, interval = 400) {\n    for (let i = 0; i < retries; i++) {\n      var _this$socket2;\n      if (((_this$socket2 = this.socket) === null || _this$socket2 === void 0 ? void 0 : _this$socket2.readyState) === WebSocket.OPEN) return;\n      await new Promise(r => setTimeout(r, interval));\n    }\n    throw new Error('WebSocket no disponible');\n  }\n\n  // ===== REST\n  async fetchMenu() {\n    const r = await fetch(`${this.baseUrl}/dishes`);\n    return r.json();\n  }\n  async createOrder(order) {\n    const r = await fetch(`${this.baseUrl}/orders`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(order)\n    });\n    if (!r.ok) throw new Error('REST /orders falló');\n    return r.json();\n  }\n  async completeOrder(orderId) {\n    const r = await fetch(`${this.baseUrl}/orders/${orderId}`, {\n      method: 'PATCH',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        status: 'completed'\n      })\n    });\n    if (!r.ok) throw new Error('REST /orders/:id falló');\n    return r.json();\n  }\n}\n\n// Singleton\nSocketService.instance = null;\nexport const socket = SocketService.getInstance();\n\n/** Inicializa subscripción POR NAMESPACE (ej: 'kitchen') */\nexport const initializeSocketConnection = (namespace, onOrders) => {\n  socket.on(`${namespace}:initial_data`, ({\n    orders\n  }) => onOrders === null || onOrders === void 0 ? void 0 : onOrders(orders || []));\n  socket.on(`${namespace}:update`, ({\n    orders\n  }) => onOrders === null || onOrders === void 0 ? void 0 : onOrders(orders || []));\n  socket.connect();\n};\n\n/** Fetch de menú de cocina */\nexport const fetchMenuItems = () => socket.fetchMenu();\n\n/** Crear orden POR NAMESPACE (kitchen) */\nexport const placeNewOrderNS = async (namespace, order) => {\n  const saved = await socket.createOrder(order);\n  await socket.waitForSocketReady();\n  socket.send({\n    type: `${namespace}:new_order`,\n    order: saved\n  });\n  return saved;\n};\n\n/** Marcar completado POR NAMESPACE (kitchen) */\nexport const markOrderAsCompletedNS = async (namespace, orderId) => {\n  await socket.completeOrder(orderId);\n  await socket.waitForSocketReady();\n  socket.send({\n    type: `${namespace}:complete_order`,\n    orderId\n  });\n};","map":{"version":3,"names":["SocketService","getInstance","instance","constructor","socket","callbacks","retryCount","hostname","window","location","wsUrl","baseUrl","connect","readyState","WebSocket","OPEN","onopen","onmessage","msg","data","JSON","parse","type","e","console","error","onclose","scheduleReconnect","onerror","delay","Math","min","setTimeout","on","cb","send","payload","_this$socket","stringify","warn","waitForSocketReady","retries","interval","i","_this$socket2","Promise","r","Error","fetchMenu","fetch","json","createOrder","order","method","headers","body","ok","completeOrder","orderId","status","initializeSocketConnection","namespace","onOrders","orders","fetchMenuItems","placeNewOrderNS","saved","markOrderAsCompletedNS"],"sources":["C:/Users/karen/OneDrive/Escritorio/Correa3/Correa/client/src/services/socket.js"],"sourcesContent":["// services/socket.js\r\nclass SocketService {\r\n  static instance = null;\r\n\r\n  static getInstance() {\r\n    if (!SocketService.instance) {\r\n      SocketService.instance = new SocketService();\r\n    }\r\n    return SocketService.instance;\r\n  }\r\n\r\n  constructor() {\r\n    this.socket = null;\r\n    this.callbacks = {};\r\n    this.retryCount = 0;\r\n\r\n    const hostname = window.location.hostname;\r\n    this.wsUrl = `ws://${hostname}:8080`; // WebSocket dinámico\r\n    this.baseUrl = `http://${hostname}:3001`; // REST\r\n  }\r\n\r\n  connect() {\r\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) return;\r\n    this.socket = new WebSocket(this.wsUrl);\r\n\r\n    this.socket.onopen = () => {\r\n      this.retryCount = 0;\r\n    };\r\n\r\n    this.socket.onmessage = (msg) => {\r\n      try {\r\n        const data = JSON.parse(msg.data);\r\n        const type = data?.type;\r\n        if (type && this.callbacks[type]) {\r\n          this.callbacks[type](data);\r\n        }\r\n      } catch (e) {\r\n        console.error('❌ Error procesando mensaje WS:', e);\r\n      }\r\n    };\r\n\r\n    this.socket.onclose = () => this.scheduleReconnect();\r\n    this.socket.onerror = (e) => console.error('⚠️ WS error:', e);\r\n  }\r\n\r\n  scheduleReconnect() {\r\n    const delay = Math.min(1000 * (2 ** this.retryCount), 30000);\r\n    this.retryCount += 1;\r\n    setTimeout(() => this.connect(), delay);\r\n  }\r\n\r\n  on(type, cb) { this.callbacks[type] = cb; }\r\n\r\n  send(payload) {\r\n    if (this.socket?.readyState === WebSocket.OPEN) {\r\n      this.socket.send(JSON.stringify(payload));\r\n    } else {\r\n      console.warn('WS no abierto, no se envió:', payload);\r\n    }\r\n  }\r\n\r\n  async waitForSocketReady(retries = 6, interval = 400) {\r\n    for (let i = 0; i < retries; i++) {\r\n      if (this.socket?.readyState === WebSocket.OPEN) return;\r\n      await new Promise(r => setTimeout(r, interval));\r\n    }\r\n    throw new Error('WebSocket no disponible');\r\n  }\r\n\r\n  // ===== REST\r\n  async fetchMenu() {\r\n    const r = await fetch(`${this.baseUrl}/dishes`);\r\n    return r.json();\r\n  }\r\n  async createOrder(order) {\r\n    const r = await fetch(`${this.baseUrl}/orders`, {\r\n      method: 'POST',\r\n      headers: {'Content-Type':'application/json'},\r\n      body: JSON.stringify(order),\r\n    });\r\n    if (!r.ok) throw new Error('REST /orders falló');\r\n    return r.json();\r\n  }\r\n  async completeOrder(orderId) {\r\n    const r = await fetch(`${this.baseUrl}/orders/${orderId}`, {\r\n      method: 'PATCH',\r\n      headers: {'Content-Type':'application/json'},\r\n      body: JSON.stringify({ status: 'completed' }),\r\n    });\r\n    if (!r.ok) throw new Error('REST /orders/:id falló');\r\n    return r.json();\r\n  }\r\n}\r\n\r\n// Singleton\r\nexport const socket = SocketService.getInstance();\r\n\r\n/** Inicializa subscripción POR NAMESPACE (ej: 'kitchen') */\r\nexport const initializeSocketConnection = (namespace, onOrders) => {\r\n  socket.on(`${namespace}:initial_data`, ({ orders }) => onOrders?.(orders || []));\r\n  socket.on(`${namespace}:update`,       ({ orders }) => onOrders?.(orders || []));\r\n  socket.connect();\r\n};\r\n\r\n/** Fetch de menú de cocina */\r\nexport const fetchMenuItems = () => socket.fetchMenu();\r\n\r\n/** Crear orden POR NAMESPACE (kitchen) */\r\nexport const placeNewOrderNS = async (namespace, order) => {\r\n  const saved = await socket.createOrder(order);\r\n  await socket.waitForSocketReady();\r\n  socket.send({ type: `${namespace}:new_order`, order: saved });\r\n  return saved;\r\n};\r\n\r\n/** Marcar completado POR NAMESPACE (kitchen) */\r\nexport const markOrderAsCompletedNS = async (namespace, orderId) => {\r\n  await socket.completeOrder(orderId);\r\n  await socket.waitForSocketReady();\r\n  socket.send({ type: `${namespace}:complete_order`, orderId });\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}