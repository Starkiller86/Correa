{"ast":null,"code":"// services/BarSocket.js\nclass BarWS {\n  static getInstance() {\n    if (!BarWS.instance) BarWS.instance = new BarWS();\n    return BarWS.instance;\n  }\n  constructor() {\n    this.ws = null;\n    this.onOrders = null;\n    const host = window.location.hostname;\n    this.wsUrl = `ws://${host}:8080`;\n    this.retry = 0;\n  }\n  connect() {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) return;\n    this.ws = new WebSocket(this.wsUrl);\n    this.ws.onopen = () => {\n      this.retry = 0;\n    };\n    this.ws.onmessage = e => {\n      var _data, _this$onOrders;\n      let data;\n      try {\n        data = JSON.parse(e.data);\n      } catch {\n        return;\n      }\n      const type = (_data = data) === null || _data === void 0 ? void 0 : _data.type;\n      if (!type || !type.startsWith('bar:')) return; // ðŸ”’ SOLO bar:*\n\n      // Normaliza a array y filtra por source==='bar'\n      const arr = Array.isArray(data.orders) ? data.orders : Array.isArray(data.order) ? data.order : data.order ? [data.order] : [];\n      if (!arr.length) return;\n      const onlyBar = arr.filter(o => ((o === null || o === void 0 ? void 0 : o.source) || 'bar') === 'bar'); // ðŸ”’ SOLO pedidos del bar\n      if (!onlyBar.length) return;\n\n      // Dedup por id dentro del batch\n      const unique = Array.from(new Map(onlyBar.map(o => [o.id, o])).values());\n      (_this$onOrders = this.onOrders) === null || _this$onOrders === void 0 ? void 0 : _this$onOrders.call(this, unique);\n    };\n    this.ws.onclose = () => this.reconnect();\n    this.ws.onerror = () => this.reconnect();\n  }\n  reconnect() {\n    const delay = Math.min(1000 * 2 ** this.retry++, 30000);\n    setTimeout(() => this.connect(), delay);\n  }\n}\nBarWS.instance = null;\nexport const initBarSocket = onOrdersArray => {\n  const inst = BarWS.getInstance();\n  inst.onOrders = onOrdersArray;\n  inst.connect();\n};\n\n// Enviar pedido del bar (REST opcional si lo tienes en otro servicio)\nexport const placeBarOrder = async order => {\n  var _inst$ws;\n  // Asegura source\n  const payload = {\n    ...order,\n    source: 'bar'\n  };\n  // Si guardas por REST, hazlo aquÃ­ y usa lo que te regrese el backend\n  const host = window.location.hostname;\n  await fetch(`http://${host}:3001/alcohol_orders`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify(payload)\n  }).catch(() => {}); // ignorable si no usas json-server para bar\n\n  // Notifica por WS\n  const inst = BarWS.getInstance();\n  if (((_inst$ws = inst.ws) === null || _inst$ws === void 0 ? void 0 : _inst$ws.readyState) === WebSocket.OPEN) {\n    inst.ws.send(JSON.stringify({\n      type: 'bar:new_order',\n      order: [payload]\n    }));\n  }\n  return payload;\n};","map":{"version":3,"names":["BarWS","getInstance","instance","constructor","ws","onOrders","host","window","location","hostname","wsUrl","retry","connect","readyState","WebSocket","OPEN","onopen","onmessage","e","_data","_this$onOrders","data","JSON","parse","type","startsWith","arr","Array","isArray","orders","order","length","onlyBar","filter","o","source","unique","from","Map","map","id","values","call","onclose","reconnect","onerror","delay","Math","min","setTimeout","initBarSocket","onOrdersArray","inst","placeBarOrder","_inst$ws","payload","fetch","method","headers","body","stringify","catch","send"],"sources":["C:/Users/karen/OneDrive/Escritorio/Correa3/Correa/client/src/services/BarSocket.js"],"sourcesContent":["// services/BarSocket.js\r\nclass BarWS {\r\n  static instance = null;\r\n  static getInstance() {\r\n    if (!BarWS.instance) BarWS.instance = new BarWS();\r\n    return BarWS.instance;\r\n  }\r\n\r\n  constructor() {\r\n    this.ws = null;\r\n    this.onOrders = null;\r\n    const host = window.location.hostname;\r\n    this.wsUrl = `ws://${host}:8080`;\r\n    this.retry = 0;\r\n  }\r\n\r\n  connect() {\r\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) return;\r\n    this.ws = new WebSocket(this.wsUrl);\r\n\r\n    this.ws.onopen = () => { this.retry = 0; };\r\n\r\n    this.ws.onmessage = (e) => {\r\n      let data;\r\n      try { data = JSON.parse(e.data); } catch { return; }\r\n      const type = data?.type;\r\n      if (!type || !type.startsWith('bar:')) return;          // ðŸ”’ SOLO bar:*\r\n\r\n      // Normaliza a array y filtra por source==='bar'\r\n      const arr = Array.isArray(data.orders) ? data.orders\r\n               : Array.isArray(data.order)  ? data.order\r\n               : data.order ? [data.order] : [];\r\n\r\n      if (!arr.length) return;\r\n\r\n      const onlyBar = arr.filter(o => (o?.source || 'bar') === 'bar'); // ðŸ”’ SOLO pedidos del bar\r\n      if (!onlyBar.length) return;\r\n\r\n      // Dedup por id dentro del batch\r\n      const unique = Array.from(new Map(onlyBar.map(o => [o.id, o])).values());\r\n\r\n      this.onOrders?.(unique);\r\n    };\r\n\r\n    this.ws.onclose = () => this.reconnect();\r\n    this.ws.onerror = () => this.reconnect();\r\n  }\r\n\r\n  reconnect() {\r\n    const delay = Math.min(1000 * (2 ** this.retry++), 30000);\r\n    setTimeout(() => this.connect(), delay);\r\n  }\r\n}\r\n\r\nexport const initBarSocket = (onOrdersArray) => {\r\n  const inst = BarWS.getInstance();\r\n  inst.onOrders = onOrdersArray;\r\n  inst.connect();\r\n};\r\n\r\n// Enviar pedido del bar (REST opcional si lo tienes en otro servicio)\r\nexport const placeBarOrder = async (order) => {\r\n  // Asegura source\r\n  const payload = { ...order, source: 'bar' };\r\n  // Si guardas por REST, hazlo aquÃ­ y usa lo que te regrese el backend\r\n  const host = window.location.hostname;\r\n  await fetch(`http://${host}:3001/alcohol_orders`, {\r\n    method: 'POST', headers: {'Content-Type':'application/json'},\r\n    body: JSON.stringify(payload)\r\n  }).catch(()=>{}); // ignorable si no usas json-server para bar\r\n\r\n  // Notifica por WS\r\n  const inst = BarWS.getInstance();\r\n  if (inst.ws?.readyState === WebSocket.OPEN) {\r\n    inst.ws.send(JSON.stringify({ type: 'bar:new_order', order: [payload] }));\r\n  }\r\n  return payload;\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}